<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ROMPETUTI - Phaser Web</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background-color: #000; }
    canvas { display: block; }
    #rotate-device-message {
      display: none;
      position: fixed; inset: 0;
      background-color: rgba(0,0,0,0.9);
      color: #fff;
      z-index: 9999;
      text-align: center;
      padding-top: 40vh;
      font-size: 20px;
      font-family: sans-serif;
      box-sizing: border-box;
      padding: 0 10px;
    }
    #fullscreen-button {
      position: fixed;
      top: 10px; right: 10px;
      z-index: 10000;
      padding: 8px 12px;
      background-color: rgba(0,0,0,0.6);
      color: #fff;
      border: 1px solid #fff;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <div id="rotate-device-message">
    Por favor, rota tu dispositivo a modo horizontal para jugar.
  </div>
  <!-- Botón opcional para pantalla completa -->
  <button id="fullscreen-button">Pantalla Completa</button>

  <script>
  window.onload = () => {
    const rotateMsg = document.getElementById('rotate-device-message');
    const fsBtn     = document.getElementById('fullscreen-button');
    let game        = null;

    function enterFullscreen() {
      if (game && !game.scale.isFullscreen) {
        game.scale.startFullscreen();
      }
      fsBtn.style.display = 'none';
    }
    fsBtn.addEventListener('click', enterFullscreen);

    function checkOrientation() {
      const isPortrait = window.matchMedia('(orientation: portrait)').matches;

      if (isPortrait) {
        // Mostrar mensaje y pausar
        rotateMsg.style.display = 'block';
        fsBtn.style.display     = 'none';
        if (game) game.scene.pause('main');
      } else {
        // Ocultar mensaje y arrancar/reanudar
        rotateMsg.style.display = 'none';
        if (!game) {
          initGame();
        } else {
          game.scene.resume('main');
          if (!game.scale.isFullscreen) {
            fsBtn.style.display = 'block';
          }
        }
      }
    }

    function initGame() {
      const config = {
        type: Phaser.AUTO,
        backgroundColor: '#000000',
        width: window.innerWidth,
        height: window.innerHeight,
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH
        },
        input: {
          activePointers: 1
        },
        scene: {
          key: 'main',
          preload: preload,
          create: create,
          update: update
        }
      };
      game = new Phaser.Game(config);
    }

    function preload() {
      // Carga de imágenes
      for (let i = 1; i <= 4; i++) {
        this.load.image(`fondo${i}`, `assets/fondo${i}.png`);
      }
      this.load.image('pantallaInicio',   'assets/pantalla_inicio.png');
      this.load.image('pantallaGameOver', 'assets/pantalla_gameover.png');
      this.load.image('rompetuti',        'assets/rompetuti.png');
      this.load.image('rompetuti2',       'assets/rompetuti2.png');
      this.load.image('inodoro',          'assets/inodoro.png');

      // Carga de audios
      this.load.audio('intro',    'assets/intro.mp3');
      this.load.audio('pintura',  'assets/pintura.mp3');
      this.load.audio('nivel',    'assets/nivel.mp3');
      this.load.audio('perdiste', 'assets/perdiste.mp3');
    }

    function create() {
      // Variables de estado
      this.jugando    = false;
      this.gameOver   = false;
      this.cacometro  = 0;
      this.banio      = 0;
      this.puntaje    = 0;
      this.nivel      = 0;
      this.pinturas   = [];
      this.manchas    = [];
      this.dirTimer   = 0;
      this.timer      = 0;

      // Música de intro
      window.musicaIntro = this.sound.add('intro', { loop: true, volume: 0.5 });
      window.musicaIntro.play();

      // Pantallas
      this.pantallaInicio = this.add.image(0, 0, 'pantallaInicio')
        .setOrigin(0).setDepth(10)
        .setDisplaySize(this.scale.width, this.scale.height);

      this.pantallaGameOver = this.add.image(0, 0, 'pantallaGameOver')
        .setOrigin(0).setDepth(10)
        .setDisplaySize(this.scale.width, this.scale.height)
        .setVisible(false);

      // Fondo inicial
      this.fondo = this.add.image(0, 0, 'fondo1')
        .setOrigin(0).setDepth(0)
        .setDisplaySize(this.scale.width, this.scale.height);

      // Sprite de rompetuti
      this.rompetuti = this.add.sprite(this.scale.width/2, 200, 'rompetuti')
        .setDepth(1)
        .setDisplaySize(160, 200);

      // Inodoro
      this.inodoro = this.add.sprite(this.scale.width/2, this.scale.height - 60, 'inodoro')
        .setDepth(1)
        .setDisplaySize(240, 120);

      // Gráficos del cacómetro/baño
      this.graphics  = this.add.graphics().setDepth(2);
      this.cacoText  = this.add.text(10, 10, 'CACÓMETRO',     { fontSize: '20px', fill: '#fff' }).setDepth(2);
      this.banioText = this.add.text(this.scale.width - 10, 10, 'BAÑO EXPLOTADO', { fontSize: '20px', fill: '#fff' })
        .setOrigin(1, 0).setDepth(2);

      // Sonidos
      this.sonidoPintura  = this.sound.add('pintura');
      this.sonidoNivel    = this.sound.add('nivel');
      this.sonidoGameOver = this.sound.add('perdiste');

      // Botón de inicio
      const startButton = this.add.text(this.scale.width/2, this.scale.height - 80, 'COMENZAR PARTIDA', {
          fontSize: '32px', fill: '#fff',
          backgroundColor: '#000', padding: { x:10, y:5 }
        })
        .setOrigin(0.5).setDepth(11)
        .setInteractive({ useHandCursor: true })
        .on('pointerdown', () => {
          // No iniciar si en portrait
          if (window.matchMedia('(orientation: portrait)').matches) return;
          // Fullscreen y comenzar
          enterFullscreen();
          this.pantallaInicio.setVisible(false);
          startButton.setVisible(false);
          this.jugando = true;
          if (window.musicaIntro.isPlaying) window.musicaIntro.stop();
        });

      // Manejo de resize
      this.scale.on('resize', (gameSize) => {
        const w = gameSize.width;
        const h = gameSize.height;
        this.cameras.resize(w, h);
        this.pantallaInicio.setDisplaySize(w, h);
        this.pantallaGameOver.setDisplaySize(w, h);
        this.fondo.setDisplaySize(w, h);
        this.rompetuti.setPosition(w/2, 200);
        this.inodoro.setPosition(w/2, h - 60);
        startButton.setPosition(w/2, h - 80);
        this.banioText.setPosition(w - 10, 10);
        this.cacoText.setPosition(10, 10);
        // Redibujar barras
        this.graphics.clear();
      });
    }

    function update(time, delta) {
      if (!this.jugando || this.gameOver) return;

      // Movimiento del inodoro con teclado
      const cursors = this.input.keyboard.createCursorKeys();
      const speed   = 8 + this.nivel;
      const w       = this.scale.width;
      const inWidth = this.inodoro.displayWidth;

      if (cursors.left.isDown)  this.inodoro.x = Phaser.Math.Clamp(this.inodoro.x - speed, inWidth/2, w - inWidth/2);
      if (cursors.right.isDown) this.inodoro.x = Phaser.Math.Clamp(this.inodoro.x + speed, inWidth/2, w - inWidth/2);

      // Movimiento automático de rompetuti
      if (this.rompetuti.vx === undefined) {
        this.rompetuti.vx = 6 * (Math.random() < 0.5 ? -1 : 1);
      }
      this.rompetuti.x += this.rompetuti.vx;
      const margin = 100;
      const rWidth = this.rompetuti.displayWidth;
      if (this.rompetuti.x < margin + rWidth/2 || this.rompetuti.x > w - margin - rWidth/2) {
        this.rompetuti.vx *= -1;
      }

      // Cambio de dirección cada 1.5s
      this.dirTimer += delta;
      if (this.dirTimer > 1500) {
        this.dirTimer = 0;
        const nv = Phaser.Math.Between(4, 6 + this.nivel);
        this.rompetuti.vx = (Math.random() < 0.5 ? -nv : nv);
      }

      // Generación de pinturas
      this.timer += delta;
      const spawnRate = Math.max(160, 1000 - this.nivel * 80);
      if (this.timer > spawnRate) {
        this.timer = 0;
        const p = this.add.rectangle(
          this.rompetuti.x,
          this.rompetuti.y + this.rompetuti.displayHeight/2 + 10,
          10, 20, 0x8B4513
        ).setDepth(1);
        this.pinturas.push(p);
        this.sonidoPintura.play();
      }

      // Movimiento y colisiones
      for (let i = this.pinturas.length - 1; i >= 0; i--) {
        const p = this.pinturas[i];
        p.y += 6 + this.nivel;
        if (Phaser.Geom.Intersects.RectangleToRectangle(p.getBounds(), this.inodoro.getBounds())) {
          p.destroy();
          this.pinturas.splice(i, 1);
          this.cacometro = Math.min(100, this.cacometro + 10);
          this.puntaje += 10;
        } else if (p.y > this.scale.height + 20) {
          this.manchas.push(
            this.add.circle(p.x, this.scale.height - 10, 6, 0x8B4513).setDepth(0)
          );
          this.banio = Math.min(100, this.banio + 10);
          p.destroy();
          this.pinturas.splice(i, 1);
        }
      }

      // Cambio de nivel
      if (this.cacometro >= 100) {
        this.cacometro = 0;
        this.nivel++;
        this.fondo.setTexture(`fondo${(this.nivel - 1) % 4 + 1}`);
        this.sonidoNivel.play();
      }

      // Dibujar barras de estado
      const g = this.graphics;
      g.clear();
      // barra caco
      g.lineStyle(2, 0x000000).strokeRect(10, 30, 200, 20);
      g.fillStyle(0x00ff00, 1).fillRect(12, 32, Math.min(196, 1.96 * this.cacometro), 16);
      // barra banio
      const w2 = this.scale.width;
      g.lineStyle(2, 0x000000).strokeRect(w2 - 210, 30, 200, 20);
      g.fillStyle(0x8B4513, 1).fillRect(w2 - 12 - Math.min(196, 1.96 * this.banio), 32, Math.min(196, 1.96 * this.banio), 16);

      // Game over
      if (this.banio >= 100 && !this.gameOver) {
        this.gameOver = true;
        this.jugando  = false;
        this.pantallaGameOver.setVisible(true);
        this.sonidoGameOver.play();
        // Botones de reinicio y salir
        const w3 = this.scale.width, h3 = this.scale.height;
        const btnRestart = this.add.text(w3/2 - 100, h3 - 80, 'VOLVER A EMPEZAR', {
          fontSize:'28px', fill:'#fff', backgroundColor:'#000', padding:{x:10,y:5}
        }).setOrigin(0.5).setDepth(11).setInteractive()
          .on('pointerdown', () => window.location.reload());
        const btnExit = this.add.text(w3/2 + 100, h3 - 80, 'SALIR', {
          fontSize:'28px', fill:'#fff', backgroundColor:'#000', padding:{x:10,y:5}
        }).setOrigin(0.5).setDepth(11).setInteractive()
          .on('pointerdown', () => window.location.reload());
      }
    }

    // Listeners globales
    checkOrientation();
    window.addEventListener('resize', checkOrientation);
    if (screen.orientation) {
      screen.orientation.addEventListener('change', checkOrientation);
    }
  };
  </script>
</body>
</html>
